# 仕様

## Slackのデータの取得

下記の理由でメッセージの取得をSlackWebAPIからではなく、エクスポートデータから参照する仕様となっています  

- メッセージの総数によってはAPIを叩く回数が膨大になるため、できるだけAPIを叩く回数を減らして、移行時間を短縮するため
- メッセージのデータ取得が途中で失敗した場合、一から取得し直さなければいけないAll or Nothingになる手間を無くすため
- メッセージにユーザーID以外のユーザー情報が含まれないため、ユーザー情報を取得するためにAPIを叩く回数が増えるため <span style="color:crimson;">※1</span>

<span style="color:crimson;">※1</span> [conversations.history](https://api.slack.com/methods/conversations.history)のAPIで取得できるメッセージは、ユーザー情報がユーザーIDのみのため、ユーザー名などのユーザー情報を取得するためには[users.info](https://api.slack.com/methods/users.info)のAPIで取得する必要があります  

## SlackBotによるユーザー情報の取得

SlackBotはユーザー情報を取得し、メッセージの送信者情報を照合するために使用されています  
これはエクスポートデータの`users.json`のユーザのIDと、メッセージに記載されているユーザーのIDが異なり、  
エクスポートデータだけではメッセージの送信者情報が照合できない可能性があるためです  
特にBotは雛形となるアプリから生成されるため、ワークスペースにデプロイし直すとBotとしては別扱いとなるのか、新しいIDが振られるようになっています  
未確認ですが、ユーザーも解除済みユーザーの[アカウントを復活させる](https://slack.com/intl/ja-jp/help/articles/360002061747-%E3%83%A1%E3%83%B3%E3%83%90%E3%83%BC%E3%81%AE%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%92%E5%BE%A9%E6%B4%BB%E3%81%95%E3%81%9B%E3%82%8B)と、IDが新しく振られる可能性があります  

## 移行のオプション機能

移行のオプション機能として、下記の機能があります  
メッセージファイルをビルドする前に、`.dist/user.json`ファイルにDiscordのユーザーIDやユーザー名を手動で設定することで機能します  

- メッセージ内のメンションなどのユーザ名の変更
- 移行したPrivateチャンネルへのユーザーの自動join

## Privateチャンネルの移行

Privateチャンネルの移行は、全てのチャンネルのエクスポートデータから移行した場合のみ可能です  
通常のエクスポートデータにはPrivateチャンネルは含まれていないため、Slackに[全てのチャンネルと会話のデータエクスポートを申請する](https://slack.com/intl/ja-jp/help/articles/1500001548241-%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E4%BC%9A%E8%A9%B1%E3%81%AE%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%99%E3%82%8B)必要があります  
申請を行うためには、申請者がSlackのビジネスプラス以上のプランかつ**ワークスペースのオーナーの権限**である必要があります  
Slackは[後からPrivate→Publicチャンネルに変更不可](https://slack.com/intl/ja-jp/help/articles/213185467-%E3%83%81%E3%83%A3%E3%83%B3%E3%83%8D%E3%83%AB%E3%82%92%E3%83%97%E3%83%A9%E3%82%A4%E3%83%99%E3%83%BC%E3%83%88%E3%83%81%E3%83%A3%E3%83%B3%E3%83%8D%E3%83%AB%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B)となっており、実質的にSlackのプロ以下のプランではPrivateチャンネルのエクスポートはできません  

## アーカイブされたチャンネルの移行

Discordにはチャンネルのアーカイブ機能がないため、アーカイブされたチャンネルはARCHIVEカテゴリーにカテゴライズされ、  
それ以外のチャンネルはCHANNELカテゴリーにカテゴライズされる仕様となっています  

## メッセージの形式

メッセージの形式は、Discordの[Embed](https://discordjs.guide/popular-topics/embeds.html#embed-preview)の機能を利用した形となっています  
メッセージは見やすいように、カラーはSlackのユーザー情報を反映しており、タイムスタンプを付けることで日付検索を可能としています  

スマホの表示では可能な限り横幅が広がっていますが、PC表示の場合はメッセージの文字数によって横幅が左右されるため、  
メッセージの最初に切り取り線を入れて、ある程度横幅が均一になるように調整をしています  
切り取り線の長さはiPhoneのminiシリーズの標準表示で改行されないギリギリの長さが基準になっています  

絵文字アイコンは下記のようにメッセージを送信したSlackユーザーのユーザータイプを示します  

| 絵文字アイコン | ユーザータイプ     |
|:------------:|:----------------|
| 🟢           | アクティブユーザー |
| 🔵           | 解除済みユーザー   |
| 🤖           | Bot             |

## 4096文字を超えるメッセージの対応

Embedのdescriptionの仕様上、Discordのメッセージは4096文字までしか入力できませんが、  
Slackのメッセージは12000文字まで入力可能なため、4096文字を超えるメッセージ(切り取り線と省略記号の50文字を含む)は省略するようにしています  
4096文字を超えるケース自体稀だと思うので、暫定対応です  

## 添付ファイルの表示位置

Discordの仕様上、Embedと添付ファイルを同じメッセージで送信した場合、添付ファイルはEmbedの上に表示されます  
そのため添付ファイルは別のEmbedとして送信することで、Embedのメッセージ下に添付ファイルが表示されるように実装しています  
Embedの仕様上、画像ファイルはプレビューできるようになっていますが、その他のファイルはプレビューできません  

## ファイルのホスティング

処理の過程で、Discordにファイルをホスティングするための`#msd-file`チャンネルを作成し、  
ユーザーのプロフィール画像やメッセージの添付ファイルなどのファイルをデプロイします  

SlackはCDNにアップロードされたファイルを消せるため、何らかの操作でSlackのファイルURLが参照できなくなった場合のリスクヘッジとして、  
ファイルはSlackのファイルURLを参照させるのではなく、Discordにファイルをデプロイし、ホスティングさせるようにしています  

Discordの仕様上、[CDNにアップロードされたファイルは消えない](https://support.discord.com/hc/en-us/community/posts/360061593771-Privacy-for-CDN-attachements))ため、ファイルのデプロイ完了後は`#msd-file`チャンネルは不要になるので削除しても問題ありません  

## 最大ファイルアップロードサイズを超えるファイル

[Slackにアップロードできる最大ファイルサイズは最大1GB](https://slack.com/intl/ja-jp/help/articles/201330736-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92-Slack-%E3%81%AB%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B)ですが、[Discordにアップロードできる最大ファイルサイズは最大100MB(※サーバーのブースト最大時)](https://support.discord.com/hc/ja/articles/360028038352-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%83%96%E3%83%BC%E3%82%B9%E3%83%88-)です  

そのため、Slackのメッセージの添付ファイルのサイズによっては、Discordにアップロードできない可能性があります  
現在、最大ファイルアップロードサイズを超えるファイルはアップロードをスキップする暫定仕様となっています  
別ストレージサービスへのアップロードなどのオプション機能は現在ありません  

より多くの添付ファイルを移行したい場合は、Discordにアップロードできる最大ファイルアップロードサイズを解放するために、[サーバーのブースト](https://support.discord.com/hc/ja/articles/360028038352-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%83%96%E3%83%BC%E3%82%B9%E3%83%88-)を検討してください  
